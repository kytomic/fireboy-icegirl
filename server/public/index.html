<!DOCTYPE html>
<html>
<head>
    <title>FireBoy and IceGirl Remastered</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./style/style.css">
    <link rel="shortcut icon" href="#">
</head>
<body>
    <div id="game-container">
        <canvas width="854px" height="480px"></canvas>

        <svg xmlns="http://www.w3.org/2000/svg" id="counter">
            <text x="40%" y="35">
                TIME:<tspan id="timer">20</tspan>
            </text>
        </svg>

        <svg xmlns="http://www.w3.org/2000/svg" id="game-start">
            <text x="50%" y="60%">Click here to start the game</text>
        </svg>

        <svg xmlns="http://www.w3.org/2000/svg" id="game-waiting">
            <text x="50%" y="60%">Waiting Another Player...</text>
        </svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" id="game-end">
            <text x="50%" y="30%">You Win the Game!</text>
            <g class="restart-button">
                <rect x="40%" y="55%" rx="5" ry="5" width="20%" height="10%"/>
                <text x="50%" y="62%">Restart</text>
            </g>

            <g class="menu-button">
                <rect x="35%" y="70%" rx="5" ry="5" width="30%" height="10%"/>
                <text x="50%" y="77%">To Main Menu</text>
            </g>
        </svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" id="game-over">        
            <text x="50%" y="30%">You Lose the Game!</text>
            <g class="restart-button">
                <rect x="40%" y="55%" rx="5" ry="5" width="20%" height="10%"/>
                <text x="50%" y="62%">Restart</text>
            </g>

            <g class="menu-button">
                <rect x="35%" y="70%" rx="5" ry="5" width="30%" height="10%"/>
                <text x="50%" y="77%">To Main Menu</text>
            </g>
        </svg>
    </div>

    <script src="/socket.io/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="scripts/bounding_box.js"></script>
    <script src="scripts/sprite.js"></script>
    <script src="scripts/player.js"></script>
    <script src="scripts/coin.js"></script>
    <script src="scripts/door.js"></script>
    <script src="scripts/bar.js"></script>
    <script src="scripts/switch.js"></script>
    <script src="scripts/socket.js"></script>
    <script src="scripts/fire.js"></script>

    <script>    
    $(document).ready(function() {
        /* Get the canvas and 2D context */
        const cv = $("canvas").get(0);
        const context = cv.getContext("2d");

        /* Create the sounds */
        const sounds = {
            background: new Audio("./media/background.mp3"),
            collect: new Audio("./media/collect.mp3"),
            trigger: new Audio("./media/trigger.mp3")
        };

        Socket.connect();
        let socket = Socket.getSocket();

        let gameStartTime = 0;      // The timestamp when the game starts

        $('#game-over').hide();
        $('#game-end').hide();
        $('#game-waiting').hide();
        $('#counter').hide();

        let playerNum = null, player = null;
        let is_gameover = false, is_gameend = null;
        let cheat_mode = null;
        let movingBoxes1 = null, movingBoxes2 = null;       

        /* Create the sprites in the game */
        let player1 = null, player2 = null; 
        let coins = null, fires = null;
        let redDoor = null, blueDoor = null;
        let redBar = null, blueBar = null;
        let redSwitch = null, blueSwitch = null;

        let assigned_player = false;

        /* The main processing of the game */
        function doFrame(now) {
            if (gameStartTime == 0) gameStartTime = now;
            
            /* Update the time remaining */
            const gameTimeSoFar = now - gameStartTime;
            const timeRemaining = Math.ceil((gameTimeSoFar) / 1000);
            $("#timer").text(timeRemaining);
                        
            // Handling bar-switch logic
            if (redSwitch.getTriggerState() == false) {
                if (redSwitch.checkTrigger(player2) == true) {
                    sounds.trigger.play();
                    movingBoxes1 = redBar.move(movingBoxes1);
                    player1.setMovingBoxes(movingBoxes1);
                }
            }
            if (blueSwitch.getTriggerState() == false) {
                if (blueSwitch.checkTrigger(player1) == true) {
                    sounds.trigger.play();
                    movingBoxes2 = blueBar.move(movingBoxes2);
                    player2.setMovingBoxes(movingBoxes2);
                }
            }
            
            // Handling coin collection
            coins.forEach(coin => {
                if (coin.getBoundingBox().intersect(player1.getBoundingBox())) {
                    sounds.collect.play();
                    player1.coinIncrement();
                    coin.hide();
                }else if (coin.getBoundingBox().intersect(player2.getBoundingBox())) {
                    sounds.collect.play();
                    player2.coinIncrement();
                    coin.hide();
                }
            })

            // Handling game-over logic
            if (!cheat_mode) {
                fires.forEach(fire => {
                    if ((fire.getBoundingBox().intersect(player1.getBoundingBox()) || fire.getBoundingBox().intersect(player2.getBoundingBox())) && !is_gameover) {
                        $(document).off('keydown');
                        $('#game-over').show();
                        is_gameover = true;
                        return;
                    }
                })

                if (is_gameover) {
                    return;
                }

                if (player != null && player.getJumping() == true) {
                    player.jump(socket, playerNum);
                }else if (player != null){
                    player.fall(socket, playerNum);
                }
            }
            
            // Handling winning logic
            let redDoorArrived = redDoor.getBoundingBox().intersect(player1.getBoundingBox());
            let blueDoorArrived = blueDoor.getBoundingBox().intersect(player2.getBoundingBox());
            if (redDoorArrived) {
                redDoor.arrivedEffect()
            }else{
                redDoor.closedEffect();
            }    
            if (blueDoorArrived) {
                blueDoor.arrivedEffect()
            }else{
                blueDoor.closedEffect();
            } 
            if (redDoorArrived && blueDoorArrived && !is_gameend) {
                $('#game-end').show();
                is_gameend = true;
                return;
            }
            
            /* Update the sprites */
            player1.update(now);
            player2.update(now);
            redBar.update(now);
            redDoor.update(now);
            blueBar.update(now);
            blueDoor.update(now);
            coins.forEach(coin => coin.update(now));
            fires.forEach(fire => fire.update(now));
            
            // /* Clear the screen */
            context.clearRect(0, 0, cv.width, cv.height);
            
            // /* Draw the sprites */
            redDoor.draw();
            blueDoor.draw();
            redBar.draw();
            blueBar.draw();
            redSwitch.draw();
            blueSwitch.draw();
            coins.forEach(coin => coin.draw())
            fires.forEach(fire => fire.draw())
            
            player1.draw();
            player2.draw();
            
            // /* Process the next frame */
            requestAnimationFrame(doFrame);
        }
        
        
        /* Handle the start of the game */
        $("#game-start").on("click", function() {
            // playerNum = null;
            player = null;
            is_gameover = false;
            is_gameend = false;
            cheat_mode = false;
            
            /* Create the game area */
            // top, left, bottom, right
            movingBoxes1 = [
                BoundingBox(context, 400, 25, 440, 280),
                BoundingBox(context, 315, 280, 440, 400),
                BoundingBox(context, 315, 25, 360, 280),
                BoundingBox(context, 315, 25, 360, 120),
                BoundingBox(context, 228, 120, 280, 300),
                BoundingBox(context, 135, 300, 280, 400),
                BoundingBox(context, 135, 25, 190, 300),
                BoundingBox(context, 20, 25, 190, 120),
                BoundingBox(context, 20, 120, 95, 400),
            ];
            movingBoxes2 = [
                BoundingBox(context, 400, 450, 440, 820),
                BoundingBox(context, 315, 450, 440, 580),
                BoundingBox(context, 315, 580, 360, 820),
                BoundingBox(context, 228, 720, 360, 820),
                BoundingBox(context, 228, 450, 280, 720),
                BoundingBox(context, 228, 450, 280, 560),
                BoundingBox(context, 135, 560, 190, 820),
                BoundingBox(context, 20, 720, 190, 820),
                BoundingBox(context, 20, 450, 95, 720),
            ];

            if (cheat_mode) {
                movingBoxes1 = [BoundingBox(context, 20, 25, 440, 400)];
                movingBoxes2 = [BoundingBox(context, 20, 450, 440, 820)];
            }

            /* Create the sprites in the game */
            player1 = Player(context, 100, 440, movingBoxes1, 1, cheat_mode); // The player 1
            player2 = Player(context, 700, 440, movingBoxes2, 2, cheat_mode); // The player 2
            coins = [
                Coin(context, 150, 430), 
                Coin(context, 550, 430),
                Coin(context, 300, 340),
                Coin(context, 650, 340),
                Coin(context, 200, 260),
                Coin(context, 750, 260),
                Coin(context, 250, 160),
                Coin(context, 700, 160),
                Coin(context, 80, 60),
                Coin(context, 650, 60)];        // The coins
            redDoor = Door(context, 340, 68, 'red');
            blueDoor = Door(context, 510, 68, 'blue');
            redBar = Bar(context, 78, 362, 'red');
            blueBar = Bar(context, 500, 272, 'blue');
            redSwitch = Switch(context, 770, 373, 'red');
            blueSwitch = Switch(context, 370, 290, 'blue');
            fires = [
                Fire(context, 347, 442),
                Fire(context, 365, 442),
                Fire(context, 382, 442),
                Fire(context, 398, 442),
                Fire(context, 28, 190),
                Fire(context, 48, 190),
                Fire(context, 820, 360),
                Fire(context, 800, 190),
                Fire(context, 820, 190),
            ]

            /* Hide the start screen */
            $("#game-start").hide();
            $("#game-waiting").show();
            sounds.background.play();
            
            if (playerNum == '1') {
                console.log('Being player 1');
                player = player1;
            }else if (playerNum == '2'){
                console.log('Being player 2');
                player = player2;
            }
            
            let is_ready = false;
            socket.emit("assign player");
            if (!assigned_player) {
                socket.on("receive player", num => {
                    if (!assigned_player) {
                        playerNum = num;
                        if (playerNum == '1') {
                            console.log('Being player 1');
                            player = player1;
                        }else if (playerNum == '2'){
                            console.log('Being player 2');
                            player = player2;
                        }
                    }
                    
                    socket.on('player ready', () => {
                        console.log('player ready');
                        is_ready = true;
                        $("#game-waiting").hide();
                        $("#counter").hide();
                        gameStartTime = 0;
                    });

                    let moveNum = 0;
                    assigned_player = true;
                    $(document).on("keydown", function(event) {
                        /* Handle the key down */
                        if (event.keyCode == 37 && is_ready) {
                            player.move(1);
                            moveNum = 1
                        }else if (event.keyCode == 38 && is_ready && cheat_mode) {
                            player.move(2);
                            moveNum = 2;
                        }else if (event.keyCode == 38 && is_ready && player.getJumping() != true) {
                            player.setJumping(true);
                            moveNum = 2;
                            return;
                        }else if (event.keyCode == 39 && is_ready){
                            player.move(3);
                            moveNum = 3;
                        }else if (event.keyCode == 40 && is_ready){
                            player.move(4);
                            moveNum = 4;
                        }
                        // Send character movement to server for synchronised animation
                        socket.emit('player' + playerNum.toString() + ' move', moveNum.toString());
                    });
                    
                    /* Handle the keyup of arrow keys and spacebar */
                    let stopNum = 0;
                    $(document).on("keyup", function(event) {
                        /* Handle the key up */
                        if (event.keyCode == 37) {
                            player.stop(1);
                            stopNum = 1;
                        }else if (event.keyCode == 38 && cheat_mode){
                            player.stop(2);
                            stopNum = 2;
                        }else if (event.keyCode == 39){
                            player.stop(3);
                            stopNum = 3;
                        }else if (event.keyCode == 40){
                            player.stop(4);
                            stopNum = 4;
                        }
                        
                        // Send character movement to server for synchronised animation
                        socket.emit('player' + playerNum.toString() + ' stop', stopNum.toString());
                    });
    
                    if (player == player1) {
                        socket.on('move player2', (num) => {
                            num = Number(num);
                            if (num == 2 && !cheat_mode) {
                                player2.setJumping(true);
                            } else {
                                player2.move(num);
                            }
                        });
                        socket.on('stop player2', (num) => {
                            num = Number(num);
                            player2.stop(num);
                        });
                        socket.on('jump player2', (cor) => {
                            player2.setXY(cor.x, cor.y)
                        })
                        socket.on('fall player2', (cor) => {
                            player2.setXY(cor.x, cor.y)
                        })
                    } else if (player == player2) {
                        socket.on('move player1', (num) => {
                            num = Number(num);
                            if (num == 2 && !cheat_mode) {
                                player1.setJumping(true);
                            } else {
                                player1.move(num);
                            }
                        });
                        socket.on('stop player1', (num) => {
                            num = Number(num);
                            player1.stop(num);
                        });
                        socket.on('jump player1', (cor) => {
                            player1.setXY(cor.x, cor.y)
                        })
                        socket.on('fall player1', (cor) => {
                            player1.setXY(cor.x, cor.y)
                        })
                    }
                    /* Start the game */
                    requestAnimationFrame(doFrame);
                });
            }
            
        });
        
        $(".restart-button").on("click", function(event) {
            $("#game-over").hide();
            $("#game-end").hide();
            $("#game-start").show();
        });

        $(".menu-button").on("click", function(event) {
            $("#game-over").hide();
            $("#game-end").hide();
            $("#game-start").show();
        });

    });

    </script>
</body>
</html>